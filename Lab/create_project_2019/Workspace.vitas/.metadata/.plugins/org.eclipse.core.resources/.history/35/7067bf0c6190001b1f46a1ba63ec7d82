/*******************************************************
 Simple example of using the minimal output only 'GPIO'
 Produces a light chaser on the Zybo LEDs
Terminal Settings:
   -Baud: 115200
   -Data bits: 8
   -Parity: no
   -Stop bits: 1
 ******************************************************/

#include <stdio.h>
#include "xparameters.h"
#include "sleep.h"

struct MyIp {
   uint32_t pdor;   // Port data output register
   uint32_t pdir; 	// For expansion
   uint32_t pddr;   // Port data direction register
   uint32_t psor; 	// For expansion
   uint32_t pcor; 	// For expansion
   uint32_t ptor; 	// For expansion
};

int main() {

	// change to XPAR_MYGPIO2_0_S00_AXI_BASEADDR because renaming components differently
  static MyIp * const myIP = reinterpret_cast<MyIp *>(XPAR_MYGPIO2_0_S00_AXI_BASEADDR);

  // leds: 3-0 outputs
  // switches: 7-4 inputs
  // buttons: 11-8 inputs
  	 myIP->pddr= 0b1111;
  	 myIP->pdor = 0b0000;

  	unint32_t buffer;
	for (;;) {

    uint32_t buttons_pdir = myIP->pdir >> 8; // shift 8 bits to the right to get the actual values of the buttons
    uint32_t switches_pdir = myIP->pdir >> 4; // shift 4 bits to the right to

    xil_printf("switches: %d\n", switches_pdir);
    xil_printf("buttons: %d\n", buttons_pdir);
    // ???? Only work
    ;
    //
    // myIP->pdor = myIP->pdor;

    // xil_printf("PDIR: %d\n", myIP->pdir);
    xil_printf("PDOR: %d\n", myIP->pdor);

    // 0000 1111 0000
    // (B)	 (S)   (L)
		switch(buttons_pdir) {
         case 0: /* Do nothing */
        	break;

         case 1<<0: 		// PDOR
          	xil_printf("button 0 pressed\n\r");
        	// PDDR Read PDDR value from switch.
          	// Then myIp->pdor = Read value.
          	// myIP->pdor = switches_pdir;
          	buffer = switches_pdir;
          	myIP->pdor = buffer;
          	break;
         case 1<<1: 		// PTOR
        	xil_printf("button 1 pressed\n\r");
          	myIP->ptor = switches_pdir;
          	break;
         case 1<<2: 		// PCOR
        	xil_printf("button 2 pressed\n\r");
          	myIP->pcor = switches_pdir;
          	break;
         case 1<<3: 		// PSOR
        	xil_printf("button 3 pressed\n\r");
          	myIP->psor = switches_pdir;
          	break;
         default:
        	xil_printf("multiple buttons pressed\n\r");
          	break;
		}
    // Wait a while

	usleep(200000);
  }
 	return 0;
}
